From 54202d211a8edcb8c73e4b84a6b7a044971552b8 Mon Sep 17 00:00:00 2001
From: bigbearishappy <953308023@qq.com>
Date: Wed, 23 Jun 2021 02:19:20 +0000
Subject: [PATCH] add reTerminal dtoverlay

---
 arch/arm/boot/dts/overlays/Makefile           |   3 +-
 .../boot/dts/overlays/reTerminal-overlay.dts  | 237 ++++++++++++++++++
 2 files changed, 239 insertions(+), 1 deletion(-)
 create mode 100644 arch/arm/boot/dts/overlays/reTerminal-overlay.dts

diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
index 823f14ee96ff..11900b5a72f1 100644
--- a/arch/arm/boot/dts/overlays/Makefile
+++ b/arch/arm/boot/dts/overlays/Makefile
@@ -225,7 +225,8 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
 	w1-gpio-pullup.dtbo \
 	w5500.dtbo \
 	wittypi.dtbo \
-	wm8960-soundcard.dtbo
+	wm8960-soundcard.dtbo \
+	reTerminal.dtbo
 
 targets += dtbs dtbs_install
 targets += $(dtbo-y)
diff --git a/arch/arm/boot/dts/overlays/reTerminal-overlay.dts b/arch/arm/boot/dts/overlays/reTerminal-overlay.dts
new file mode 100644
index 000000000000..13495417c777
--- /dev/null
+++ b/arch/arm/boot/dts/overlays/reTerminal-overlay.dts
@@ -0,0 +1,237 @@
+/*
+ * Copyright (C) 2021 Seeed Studio
+ * Zhangqun Ming <north_sea@qq.com>
+ *
+ * MIT License
+ *
+ */
+/dts-v1/;
+/plugin/;
+
+/ {
+    compatible = "brcm,bcm2835", "brcm,bcm2708", "brcm,bcm2709", "brcm,bcm2711";
+
+    fragment@0 {
+        target-path="/";
+        __overlay__ {
+            hardware = "reTerminal V1.2";
+        };
+    };
+
+	fragment@1 {
+		target = <&dsi1>;
+		__overlay__ {
+			#address-cells = <1>;
+			#size-cells = <0>;
+			status = "okay";
+
+			port {
+				dsi_out_port: endpoint {
+					remote-endpoint = <&panel_dsi_port>;
+				};
+			};
+		};
+	};
+	
+	fragment@2 {
+		target = <&gpio>;
+		__overlay__ {
+			power_key: power_key {
+				brcm,pins = <13>;    /* gpio number */
+				brcm,function = <0>; /* 0 = input, 1 = output */
+				brcm,pull = <2>;     /* 0 = none, 1 = pull down, 2 = pull up */
+			};
+
+			mcp23008_pins: mcp23008_pins@20 {
+				brcm,pins = <6>;     /* gpio number */
+				brcm,function = <0>; /* 0 = input, 1 = output */
+				brcm,pull = <2>;     /* 0 = none, 1 = pull down, 2 = pull up */
+			};
+		};
+	};
+
+	fragment@3 {
+		target = <&mcp23008>;
+		mcp23008_irq: __overlay__ {
+			#interrupt-cells=<2>;
+			interrupt-parent = <&gpio>;
+			interrupts = <6 2>; /* IRQ_TYPE_EDGE_FALLING */
+			interrupt-controller;
+			microchip,irq-mirror;
+		};
+	};
+
+	fragment@4 {
+		target = <&i2c1>;
+		__overlay__ {
+			status = "okay";
+
+			/* this is the configuration part */
+			clock-frequency = <300000>;
+
+			#address-cells = <1>;
+			#size-cells = <0>;
+			
+			lis331dlh@19 {
+				compatible = "st,lis331dlh";
+				reg = <0x19>;
+				status = "okay";
+			};
+			
+			mcp23008: mcp@20 {
+				compatible = "microchip,mcp23008";
+				reg = <0x20>;
+				status = "okay";
+
+				gpio-controller;
+				#gpio-cells = <2>;
+
+				input_pins: pinmux {
+					pins =
+						"gpio0",
+						"gpio1",
+						"gpio2",
+						"gpio3";
+					bias-pull-up;
+				};
+			};
+
+			ltr303@29 {
+				compatible = "ltr303,liteon";
+				reg = <0x29>;
+				status = "okay";
+			};
+			
+			mipi_dsi@45 {
+				compatible = "i2c_dsi,ili9881d";
+				reg = <0x45>;
+				port {
+					panel_dsi_port: endpoint {
+						remote-endpoint = <&dsi_out_port>;
+					};
+				};
+			};
+		};
+	};
+
+	fragment@5 {
+		target = <&i2c3>;
+		__overlay__ {
+			status = "okay";
+
+			/* this is the configuration part */
+			clock-frequency = <100000>;
+
+			#address-cells = <1>;
+			#size-cells = <0>;
+			
+			pcf8563@51 {
+				compatible = "nxp,pcf8563";
+				reg = <0x51>;
+			};
+		};
+	};
+
+	fragment@6 {
+		target = <&leds>;
+		__overlay__ {
+			compatible = "gpio-leds";
+
+			usr_led0: usr_led0 {
+				label = "usr_led0";
+				linux,default-trigger = "default-off";
+				gpios = <&mcp23008 4 1>;
+			};
+
+			usr_led1: usr_led1 {
+				label = "usr_led1";
+				linux,default-trigger = "default-off";
+				gpios = <&mcp23008 5 1>;
+			};
+
+			usr_led2: usr_led2 {
+				label = "usr_led2";
+				linux,default-trigger = "default-off";
+				gpios = <&mcp23008 6 1>;
+			};
+
+			usr_buzzer: usr_led3 {
+				label = "usr_buzzer";
+				linux,default-trigger = "default-off";
+				gpios = <&mcp23008 7 0>;
+				default-state = "off";
+			};
+		};
+	};
+
+	fragment@7 {
+		target-path="/";
+		__overlay__ {
+			gpio_keys {
+				compatible = "gpio-keys";
+				pinctrl-names = "default";
+				pinctrl-0 = <&input_pins>;
+				status = "okay";
+
+				usr_btn0: usr_btn0 {
+					debounce-interval = <5>;
+					linux,code = <30>; /* BTN_0, KEY_A */
+					label = "usr_btn0";
+					gpios = <&mcp23008 0 1>;
+					gpio-key,wakeup;
+					autorepeat;
+				};
+
+				usr_btn1: usr_btn1 {
+					debounce-interval = <5>;
+					linux,code = <31>; /* BTN_1, KEY_S */
+					label = "usr_btn1";
+					gpios = <&mcp23008 2 1>;
+					gpio-key,wakeup;
+					autorepeat;
+				};
+
+				usr_btn2: usr_btn2 {
+					debounce-interval = <5>;
+					linux,code = <32>; /* BTN_2, KEY_D */
+					label = "usr_btn2";
+					gpios = <&mcp23008 1 1>;
+					gpio-key,wakeup;
+					autorepeat;
+				};
+
+				usr_btn3: usr_btn3 {
+					debounce-interval = <5>;
+					linux,code = <33>; /* BTN_3, KEY_F */
+					label = "usr_btn3";
+					gpios = <&mcp23008 3 1>;
+					gpio-key,wakeup;
+					autorepeat;
+				};
+
+				pwr_btn: pwr_btn {
+					debounce-interval = <5>;
+					linux,code = <142>; /* PWR_KEY, KEY_SLEEP */
+					label = "power_key";
+					gpios = <&gpio 13 1>;
+					gpio-key,wakeup;
+					autorepeat;
+				};
+			};
+		};
+	};
+
+	__overrides__ {
+		int = <&mcp23008_pins>,"brcm,pins:0",
+				<&mcp23008_irq>,"interrupts:0";
+		addr = <&mcp23008>,"reg:0", 
+				<&mcp23008_pins>,"reg:0";
+		noints = <0>,"!1!2";
+
+		key0 = <&usr_btn0>,"linux,code:0";
+		key1 = <&usr_btn1>,"linux,code:0";
+		key2 = <&usr_btn2>,"linux,code:0";
+		key3 = <&usr_btn3>,"linux,code:0";
+	};
+};
+
-- 
2.25.1

